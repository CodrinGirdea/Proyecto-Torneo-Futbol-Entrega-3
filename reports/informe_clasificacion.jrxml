<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="informe_clasificacion" pageWidth="595" pageHeight="842" columnWidth="535" leftMargin="30" rightMargin="30" topMargin="20" bottomMargin="20">

    <!-- PARÁMETROS -->
    <parameter name="TITULO" class="java.lang.String" isForPrompting="false">
        <defaultValueExpression><![CDATA["Tabla de Clasificación y Eliminatorias"]]></defaultValueExpression>
    </parameter>
    
    <parameter name="ELIMINATORIA" class="java.lang.String" isForPrompting="false">
        <defaultValueExpression><![CDATA[null]]></defaultValueExpression>
    </parameter>

    <!-- CONSULTA SQL -->
    <queryString>
        <![CDATA[
SELECT 
    e.id AS equipo_id,
    e.nombre AS equipo_nombre,
    e.curso AS equipo_curso,
    COUNT(DISTINCT CASE WHEN p.jugado = 1 THEN p.id END) AS partidos_jugados,
    SUM(CASE 
        WHEN p.jugado = 1 AND (
            (p.equipo_local_id = e.id AND p.goles_local > p.goles_visitante) OR
            (p.equipo_visitante_id = e.id AND p.goles_visitante > p.goles_local)
        ) THEN 1 ELSE 0 
    END) AS victorias,
    SUM(CASE 
        WHEN p.jugado = 1 AND p.equipo_local_id = e.id THEN p.goles_local
        WHEN p.jugado = 1 AND p.equipo_visitante_id = e.id THEN p.goles_visitante
        ELSE 0
    END) AS goles_favor,
    SUM(CASE 
        WHEN p.jugado = 1 AND p.equipo_local_id = e.id THEN p.goles_visitante
        WHEN p.jugado = 1 AND p.equipo_visitante_id = e.id THEN p.goles_local
        ELSE 0
    END) AS goles_contra
FROM equipos e
LEFT JOIN partidos p ON (e.id = p.equipo_local_id OR e.id = p.equipo_visitante_id)
    AND ($P{ELIMINATORIA} IS NULL OR p.eliminatoria = $P{ELIMINATORIA})
GROUP BY e.id, e.nombre, e.curso
ORDER BY 
    victorias DESC, 
    (goles_favor - goles_contra) DESC, 
    goles_favor DESC
        ]]>
    </queryString>

    <!-- CAMPOS -->
    <field name="equipo_id" class="java.lang.Integer"/>
    <field name="equipo_nombre" class="java.lang.String"/>
    <field name="equipo_curso" class="java.lang.String"/>
    <field name="partidos_jugados" class="java.lang.Integer"/>
    <field name="victorias" class="java.lang.Integer"/>
    <field name="goles_favor" class="java.lang.Integer"/>
    <field name="goles_contra" class="java.lang.Integer"/>

    <!-- VARIABLES -->
    <variable name="diferencia_goles" class="java.lang.Integer" calculation="Nothing">
        <variableExpression><![CDATA[$F{goles_favor} - $F{goles_contra}]]></variableExpression>
    </variable>

    <variable name="posicion" class="java.lang.Integer" calculation="Count">
        <variableExpression><![CDATA[$V{REPORT_COUNT}]]></variableExpression>
    </variable>

    <!-- TITULO -->
    <title>
        <band height="80">
            <rectangle>
                <reportElement x="0" y="0" width="535" height="60" backcolor="#2C3E50"/>
                <graphicElement><pen lineWidth="0"/></graphicElement>
            </rectangle>
            <staticText>
                <reportElement x="10" y="5" width="400" height="18" forecolor="#FFFFFF"/>
                <textElement verticalAlignment="Middle">
                    <font fontName="Arial" size="12" isBold="true"/>
                </textElement>
                <text><![CDATA[⚽ SISTEMA DE GESTIÓN DE TORNEO DE FÚTBOL]]></text>
            </staticText>
            <staticText>
                <reportElement x="10" y="23" width="300" height="12" forecolor="#ECF0F1"/>
                <textElement verticalAlignment="Middle">
                    <font fontName="Arial" size="8"/>
                </textElement>
                <text><![CDATA[IES Brianda de Mendoza - 2º DAM]]></text>
            </staticText>
            <textField>
                <reportElement x="10" y="38" width="400" height="18" forecolor="#FFFFFF"/>
                <textElement verticalAlignment="Middle">
                    <font fontName="Arial" size="14" isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA[$P{TITULO}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="420" y="40" width="115" height="16" forecolor="#ECF0F1"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font fontName="Arial" size="8"/>
                </textElement>
                <textFieldExpression><![CDATA[new java.text.SimpleDateFormat("dd/MM/yyyy HH:mm").format(new java.util.Date())]]></textFieldExpression>
            </textField>
            <line>
                <reportElement x="0" y="75" width="535" height="2" forecolor="#F39C12"/>
                <graphicElement><pen lineWidth="2"/></graphicElement>
            </line>
        </band>
    </title>

    <!-- COLUMN HEADER -->
    <columnHeader>
        <band height="40">
            <rectangle>
                <reportElement x="0" y="0" width="535" height="35" backcolor="#34495E"/>
                <graphicElement><pen lineWidth="0"/></graphicElement>
            </rectangle>
            
            <staticText>
                <reportElement x="0" y="0" width="215" height="35" forecolor="#FFFFFF"/>
                <box leftPadding="5"><pen lineWidth="0.5" lineColor="#2C3E50"/></box>
                <textElement verticalAlignment="Middle">
                    <font fontName="Arial" size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[EQUIPO]]></text>
            </staticText>
            
            <staticText>
                <reportElement x="215" y="0" width="80" height="35" forecolor="#FFFFFF"/>
                <box><pen lineWidth="0.5" lineColor="#2C3E50"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[CURSO]]></text>
            </staticText>
            
            <staticText>
                <reportElement x="295" y="0" width="60" height="35" forecolor="#FFFFFF"/>
                <box><pen lineWidth="0.5" lineColor="#2C3E50"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[PJ]]></text>
            </staticText>
            
            <staticText>
                <reportElement x="355" y="0" width="60" height="35" forecolor="#FFFFFF"/>
                <box><pen lineWidth="0.5" lineColor="#2C3E50"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[V]]></text>
            </staticText>
            
            <staticText>
                <reportElement x="415" y="0" width="40" height="35" forecolor="#FFFFFF"/>
                <box><pen lineWidth="0.5" lineColor="#2C3E50"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[GF]]></text>
            </staticText>
            
            <staticText>
                <reportElement x="455" y="0" width="40" height="35" forecolor="#FFFFFF"/>
                <box><pen lineWidth="0.5" lineColor="#2C3E50"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[GC]]></text>
            </staticText>
            
            <staticText>
                <reportElement x="495" y="0" width="40" height="35" forecolor="#FFFFFF"/>
                <box><pen lineWidth="0.5" lineColor="#2C3E50"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[DIF]]></text>
            </staticText>
        </band>
    </columnHeader>

    <!-- DETALLE -->
    <detail>
        <band height="25">
            <!-- Rectángulos oro/plata/bronce -->
            <rectangle>
                <reportElement x="0" y="0" width="535" height="23" backcolor="#FFD700">
                    <printWhenExpression><![CDATA[$V{posicion} == 1]]></printWhenExpression>
                </reportElement>
                <graphicElement><pen lineWidth="0"/></graphicElement>
            </rectangle>
            <rectangle>
                <reportElement x="0" y="0" width="535" height="23" backcolor="#C0C0C0">
                    <printWhenExpression><![CDATA[$V{posicion} == 2]]></printWhenExpression>
                </reportElement>
                <graphicElement><pen lineWidth="0"/></graphicElement>
            </rectangle>
            <rectangle>
                <reportElement x="0" y="0" width="535" height="23" backcolor="#CD7F32">
                    <printWhenExpression><![CDATA[$V{posicion} == 3]]></printWhenExpression>
                </reportElement>
                <graphicElement><pen lineWidth="0"/></graphicElement>
            </rectangle>

            <!-- Campos del detalle -->
            <textField>
                <reportElement x="0" y="0" width="215" height="23"/>
                <box leftPadding="5"><pen lineWidth="0.5" lineColor="#ECF0F1"/></box>
                <textElement verticalAlignment="Middle">
                    <font fontName="Arial" size="10"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{equipo_nombre}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="215" y="0" width="80" height="23"/>
                <box><pen lineWidth="0.5" lineColor="#ECF0F1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="10"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{equipo_curso}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="295" y="0" width="60" height="23"/>
                <box><pen lineWidth="0.5" lineColor="#ECF0F1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="10"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{partidos_jugados}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="355" y="0" width="60" height="23"/>
                <box><pen lineWidth="0.5" lineColor="#ECF0F1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="10"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{victorias}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="415" y="0" width="40" height="23"/>
                <box><pen lineWidth="0.5" lineColor="#ECF0F1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="10"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{goles_favor}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="455" y="0" width="40" height="23"/>
                <box><pen lineWidth="0.5" lineColor="#ECF0F1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="10"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{goles_contra}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="495" y="0" width="40" height="23"/>
                <box><pen lineWidth="0.5" lineColor="#ECF0F1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="10"/>
                </textElement>
                <textFieldExpression><![CDATA[($V{diferencia_goles} >= 0 ? "+" : "") + $V{diferencia_goles}]]></textFieldExpression>
            </textField>
        </band>
    </detail>

    <!-- PAGE FOOTER -->
    <pageFooter>
        <band height="30">
            <line>
                <reportElement x="0" y="5" width="535" height="1" forecolor="#CCCCCC"/>
                <graphicElement><pen lineWidth="0.5"/></graphicElement>
            </line>
            <textField>
                <reportElement x="10" y="10" width="200" height="15" forecolor="#7F8C8D"/>
                <textElement verticalAlignment="Middle">
                    <font fontName="Arial" size="8"/>
                </textElement>
                <textFieldExpression><![CDATA["Generado con JasperReports"]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="435" y="10" width="80" height="15" forecolor="#7F8C8D"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font fontName="Arial" size="8"/>
                </textElement>
                <textFieldExpression><![CDATA["Página " + $V{PAGE_NUMBER}]]></textFieldExpression>
            </textField>
        </band>
    </pageFooter>

    <!-- SUMMARY -->
    <summary>
        <band height="40">
            <line>
                <reportElement x="0" y="5" width="535" height="1" forecolor="#F39C12"/>
                <graphicElement><pen lineWidth="2"/></graphicElement>
            </line>
            <staticText>
                <reportElement x="10" y="15" width="515" height="20" forecolor="#7F8C8D"/>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font fontName="Arial" size="9" isItalic="true"/>
                </textElement>
                <text><![CDATA[Leyenda: PJ = Partidos Jugados | V = Victorias | GF = Goles a Favor | GC = Goles en Contra | DIF = Diferencia de Goles]]></text>
            </staticText>
        </band>
    </summary>

</jasperReport>
